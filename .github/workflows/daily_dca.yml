name: Daily Bitkub DCA

on:
  schedule:
    # Run every 15 minutes to align with 15m candle analysis
    # This prevents edge cases (e.g. target 14:30 vs run 14:20/14:40)
    # Billing Impact: ~480 mins/month (well within free tier)
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      amount:
        description: 'Amount in THB'
        required: true
        default: '250'
      symbol:
        description: 'Symbol (e.g. BTC_THB)'
        required: true
        default: 'BTC_THB'
      force_run:
        description: 'Set true to bypass time check'
        type: boolean
        default: false

jobs:
  trade:
    runs-on: ubuntu-latest
    
    steps:
    - name: Safety Check (Once Per Day)
      id: safety_check
      # Skip check if manual force run
      if: github.event_name == 'schedule'
      env:
        LAST_BUY_DATE: ${{ vars.LAST_BUY_DATE }}
        # UTC Offset (e.g. '+7' for BKK). Must match format expected by `date -d`
        TIMEZONE_OFFSET: ${{ vars.TIMEZONE_OFFSET || '+7' }} 
      run: |
        # Get Current Date in Local Time
        TODAY_LOCAL=$(date -d "$TIMEZONE_OFFSET hours" +%Y-%m-%d)
        
        echo "Today (Local): $TODAY_LOCAL"
        echo "Last Buy:      $LAST_BUY_DATE"
        
        if [ "$TODAY_LOCAL" == "$LAST_BUY_DATE" ]; then
          echo "⛔ Already bought today. Skipping."
          echo "safe_to_run=false" >> $GITHUB_OUTPUT
        else
          echo "✅ New day detected. Proceeding to time check."
          echo "safe_to_run=true" >> $GITHUB_OUTPUT
        fi

    - name: Check Time Window (Bash)
      id: check_time
      # Only run if manual force OR safety check passes
      if: github.event_name == 'workflow_dispatch' || steps.safety_check.outputs.safe_to_run == 'true'
      env:
        # Defaults to 14:45 if variable not set
        TARGET_TIME_LOCAL: ${{ vars.DCA_TARGET_TIME || '14:45' }}
        TIMEZONE_OFFSET: ${{ vars.TIMEZONE_OFFSET || '+7' }}
      run: |
        # 1. Parse Target Hour:Minute
        TARGET_HH=$(echo $TARGET_TIME_LOCAL | cut -d: -f1)
        TARGET_MM=$(echo $TARGET_TIME_LOCAL | cut -d: -f2)

        # 2. Get Current Local Time (via Offset)
        # We use date calculation to handle day rollover if needed
        # Format: HHMM (e.g., 1445)
        NOW_LOCAL_HHMM=$(date -d "$TIMEZONE_OFFSET hours" +%H%M)
        TARGET_HHMM="${TARGET_HH}${TARGET_MM}"
        
        echo "Target Local: $TARGET_HHMM"
        echo "Current Local: $NOW_LOCAL_HHMM"

        # 3. Calculate Difference in Minutes
        # Convert both to "minutes from midnight"
        NOW_MINS=$(( 10#${NOW_LOCAL_HHMM:0:2} * 60 + 10#${NOW_LOCAL_HHMM:2:2} ))
        TARGET_MINS=$(( 10#$TARGET_HH * 60 + 10#$TARGET_MM ))
        
        DIFF=$(( NOW_MINS - TARGET_MINS ))
        # Absolute value
        DIFF=${DIFF#-}

        # Threshold: 7 minutes (since we run every 15, closest is <7.5)
        if [ "$DIFF" -le 7 ]; then
          echo "✅ MATCH! Within matched window."
          echo "match=true" >> $GITHUB_OUTPUT
        else
          echo "❌ Skipping. Diff is $DIFF minutes."
          echo "match=false" >> $GITHUB_OUTPUT
        fi

    - uses: actions/checkout@v3
      # Only download repo if we are running!
      if: github.event_name == 'workflow_dispatch' || steps.check_time.outputs.match == 'true'

    - name: Set up Python
      if: github.event_name == 'workflow_dispatch' || steps.check_time.outputs.match == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      if: github.event_name == 'workflow_dispatch' || steps.check_time.outputs.match == 'true'
      run: pip install requests

    - name: Run DCA Script
      if: github.event_name == 'workflow_dispatch' || steps.check_time.outputs.match == 'true'
      id: trade_execution
      continue-on-error: true # Allow this step to fail so we can handle it
      env:
        BITKUB_API_KEY: ${{ secrets.BITKUB_API_KEY }}
        BITKUB_API_SECRET: ${{ secrets.BITKUB_API_SECRET }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        DCA_AMOUNT_THB: ${{ inputs.amount || '350' }}
        SYMBOL_THB: ${{ inputs.symbol || 'BTC_THB' }}
      run: python bitkub-dca.py

    - name: Handle Failure (Mark as Done to Skip Retry)
      if: steps.trade_execution.outcome == 'failure'
      env:
        GH_TOKEN: ${{ secrets.GH_PAT_FOR_VARS }}
        TIMEZONE_OFFSET: ${{ vars.TIMEZONE_OFFSET || '+7' }}
      run: |
        echo "❌ Trade Failed. Marking today as 'done' to prevent retries..."
        TODAY_LOCAL=$(date -d "$TIMEZONE_OFFSET hours" +%Y-%m-%d)
        gh variable set LAST_BUY_DATE --body "$TODAY_LOCAL"

    - name: Update Last Buy Date (Success Case)
      if: steps.trade_execution.outcome == 'success'
      env:
        GH_TOKEN: ${{ secrets.GH_PAT_FOR_VARS }}
        TIMEZONE_OFFSET: ${{ vars.TIMEZONE_OFFSET || '+7' }}
      run: |
        TODAY_LOCAL=$(date -d "$TIMEZONE_OFFSET hours" +%Y-%m-%d)
        echo "Updating LAST_BUY_DATE to $TODAY_LOCAL..."
        gh variable set LAST_BUY_DATE --body "$TODAY_LOCAL"
